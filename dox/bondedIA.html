<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESPResSo: Bonded interactions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_48x48.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ESPResSo
   </div>
   <div id="projectbrief">Extensible Simulation Package for Research on Soft Matter Systems</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('bondedIA.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Bonded interactions </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#bondedIA_new">Adding new interactions</a><ul><li class="level2"><a href="#bondedIA_new_struct">Defining the new interaction</a></li>
<li class="level2"><a href="#bondedIA_new_integration">Integrating the new bond type into the C++ core</a></li>
<li class="level2"><a href="#bondedIA_new_interface">Adding the interaction in the Python interface</a></li>
</ul>
</li>
<li class="level1"><a href="#bondedIA_bond_angles">Bond angle potentials</a><ul><li class="level2"><a href="#bondedIA_angle_force">General expressions for the forces</a></li>
<li class="level2"><a href="#bondedIA_angle_potentials">Available potentials</a><ul><li class="level3"><a href="#bondedIA_angle_harmonic">Harmonic angle potential</a></li>
<li class="level3"><a href="#bondedIA_angle_cossquare">Harmonic cosine potential</a></li>
<li class="level3"><a href="#bondedIA_angle_cosine">Cosine potential</a></li>
<li class="level3"><a href="#bondedIA_angle_tab">Tabulated potential</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="bondedIA_new"></a>
Adding new interactions</h1>
<p>To add a new bonded interaction, the following steps are required:</p><ul>
<li>C++ core:<ul>
<li>Create a new header file for your new bond type, preferably inside the folder <code>src/core/bonded_interactions</code>.</li>
<li>Define a data structure for the interaction parameters (prefactors, etc.).</li>
<li>Write a constructor and force/energy kernels.</li>
<li>Add calls to these kernels in the force, energy and pressure calculation functions.</li>
<li>Register the new bond type.</li>
</ul>
</li>
<li>Python interface:<ul>
<li>Import the definition of the interaction struct from the core</li>
<li>Implement a class for the bonded interaction derived from the Python <code>BondedInteraction</code> base class</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="bondedIA_new_struct"></a>
Defining the new interaction</h2>
<p>Every interaction resides in its own source .cpp and .hpp files. A simple example for a bonded interaction is the FENE bond in <a class="el" href="fene_8hpp.html">fene.hpp</a> and <a class="el" href="fene_8cpp.html">fene.cpp</a>. Use these two files as templates for your interaction.</p>
<p>The first step is to create a new <code>struct</code> which represents your new bond type inside the .hpp file. It needs to have the following members:</p>
<ul>
<li><div class="fragment"><div class="line"><span class="keyword">static</span> constexpr <span class="keywordtype">int</span> num = 1;</div>
</div><!-- fragment --> This is the number of particles involved in the bond, minus 1, i.e. 1 for a pairwise bonded potential such as the FENE bond.</li>
<li><div class="fragment"><div class="line"><span class="keywordtype">double</span> <a class="code" href="namespaceCoulomb.html#a756bd1c367d1c6bda424090134c7013f">cutoff</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> r0 + drmax; }</div>
</div><!-- fragment --> The return value of <code><a class="el" href="namespaceCoulomb.html#a756bd1c367d1c6bda424090134c7013f">cutoff()</a></code> should be as large as the interaction range of the new interaction. This is only relevant to pairwise bonds and dihedral bonds. In all other cases, the return value should be -1, namely angle bonds as well as other bonds that don't have an interaction range.</li>
<li><div class="fragment"><div class="line">boost::optional&lt;Utils::Vector3d&gt; <a class="code" href="DipolarBarnesHut__cuda_8cu.html#a49f2a9bfcf5f73fc8e2d58bf78819909">force</a>(<a class="code" href="classUtils_1_1Vector.html">Utils::Vector3d</a> <span class="keyword">const</span> &amp;dx) <span class="keyword">const</span>;</div>
</div><!-- fragment --> This function returns the bond force. If it is a bond involving three or four particles, a <code>std::tuple</code> with three or four force vectors has to be returned, respectively.<ul>
<li>The returned value is in a <code>boost::optional</code> container if the bond is breakable. If the bond is broken, the returned object is empty; this will stop the integrator with a runtime error.</li>
<li>The function can make use of a pre-calculated distance vector (<code>dx</code>) pointing from particle 2 to particle 1, that takes periodic boundary conditions into account.</li>
<li>The function name and signature may be different, e.g. for angle bonds. To determine the right signature for the new interaction, you can have a look at <a class="el" href="forces__inline_8hpp.html">forces_inline.hpp</a> to see where this function will be called and which other variables may be available for your calculation.</li>
</ul>
</li>
<li><div class="fragment"><div class="line">boost::optional&lt;double&gt; energy(<a class="code" href="classUtils_1_1Vector.html">Utils::Vector3d</a> <span class="keyword">const</span> &amp;dx) <span class="keyword">const</span>;</div>
</div><!-- fragment --> This function returns the bond energy. The same information as given for the force calculation above applies here. This function will be called from <a class="el" href="energy__inline_8hpp.html">energy_inline.hpp</a> .</li>
<li>An explicit default constructor, for example <div class="fragment"><div class="line"><a class="code" href="structFeneBond.html">FeneBond</a>() = <span class="keywordflow">default</span>;</div>
</div><!-- fragment --></li>
<li>A custom constructor which is used to set all parameters and to do preparatory calculations if necessary, for example <div class="fragment"><div class="line"><a class="code" href="structFeneBond.html">FeneBond</a>(<span class="keywordtype">double</span> k, <span class="keywordtype">double</span> drmax, <span class="keywordtype">double</span> r0);</div>
</div><!-- fragment --> All values the bond needs to function properly should be passed as arguments to this constructor.</li>
<li>A template function for serialization called <code>serialize</code>. This is for communication between nodes in parallel computations. The following function can serve as a starting point. <div class="fragment"><div class="line"><span class="keyword">private</span>:</div>
<div class="line"><span class="keyword">friend</span> boost::serialization::access;</div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Archive&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="namespaceboost_1_1serialization.html#a955fbdf06d317317d76921465e894ef4">serialize</a>(Archive &amp;ar, <span class="keywordtype">long</span> <span class="keywordtype">int</span>) {</div>
<div class="line">  ar &amp;k;</div>
<div class="line">  ar &amp;drmax;</div>
<div class="line">  ar &amp;r0;</div>
<div class="line">  ar &amp;drmax2;</div>
<div class="line">  ar &amp;drmax2i;</div>
<div class="line">}</div>
</div><!-- fragment --> Replace all the <code>ar&amp;</code> commands with the new bond's parameters. Every data member of your struct needs to be transmitted. This template function is private.</li>
</ul>
<h2><a class="anchor" id="bondedIA_new_integration"></a>
Integrating the new bond type into the C++ core</h2>
<p>In most cases, there are three files that need to be updated to integrate the new bond type into the core, namely</p><ul>
<li><a class="el" href="bonded__interaction__data_8hpp.html">bonded_interaction_data.hpp</a></li>
<li><a class="el" href="forces__inline_8hpp.html">forces_inline.hpp</a></li>
<li><a class="el" href="energy__inline_8hpp.html">energy_inline.hpp</a></li>
</ul>
<p>In some cases, you may also need to modify <a class="el" href="pressure__inline_8hpp.html">pressure_inline.hpp</a>.</p>
<ul>
<li>In <a class="el" href="bonded__interaction__data_8cpp.html">bonded_interaction_data.cpp</a>:<ul>
<li>Include the header file containing the new bond type.</li>
<li>Add the new bond type to <a class="el" href="bonded__interaction__data_8hpp.html#ae9c6a4fa697aa0a90b4dceb7b79e1f5f">Bonded_IA_Parameters</a> at the end of the types list.</li>
<li>If by doing this, the length of the list in Bonded_IA_Parameters passes over a multiple of 10, you may have to update ESPResSo's top level CMakeLists.txt: <div class="fragment"><div class="line"><span class="preprocessor"># enable boost::variant with more than 20 types</span></div>
<div class="line">target_compile_options(</div>
<div class="line">cxx_interface INTERFACE -DBOOST_MPL_CFG_NO_PREPROCESSED_HEADERS</div>
<div class="line">                        -DBOOST_MPL_LIMIT_LIST_SIZE=40)</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>In <a class="el" href="forces__inline_8hpp.html">forces_inline.hpp</a>:<ul>
<li>A call to the new bond's force calculation needs to be placed in either of the functions <a class="el" href="forces__inline_8hpp.html#a93a751c4d3cce412573e5a2c9dfd896b">calc_bond_pair_force()</a>, <a class="el" href="forces__inline_8hpp.html#a58dfe7c4fb983f149b54b3adc0fc7f6b">calc_bonded_three_body_force()</a> or <a class="el" href="forces__inline_8hpp.html#a0b752e4c32180b36b47d311297372e03">calc_bonded_four_body_force()</a>, depending on how many bond partners there are.</li>
<li>Add the new entry to the <code>if</code> - <code>else</code> chain, like in the following example <div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> <span class="keyword">const</span> *iap = boost::get&lt;QuarticBond&gt;(&amp;iaparams)) {</div>
<div class="line">  <span class="keywordflow">return</span> iap-&gt;force(dx);</div>
<div class="line">}</div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --></li>
</ul>
</li>
<li>In <a class="el" href="energy__inline_8hpp.html">energy_inline.hpp</a>:<ul>
<li>A call to the new bond's force calculation needs to be placed in <a class="el" href="energy__inline_8hpp.html#a7a3ee3c5c02aa5c4ef608490aace31f5">calc_bonded_energy</a>. Find the <code>if</code> - <code>else</code> chain that corresponds to the correct number of bond partners.</li>
<li>Add the new entry to the <code>if</code> - <code>else</code> chain, like in the following example <div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> <span class="keyword">const</span> *iap = boost::get&lt;QuarticBond&gt;(&amp;iaparams)) {</div>
<div class="line">  <span class="keywordflow">return</span> iap-&gt;energy(dx);</div>
<div class="line">}</div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Pressure tensor and virial calculation (<a class="el" href="pressure__inline_8hpp.html">pressure_inline.hpp</a>): if your bonded interaction is not a pair bond or modifies the particles involved, you have to implement a custom solution for virial calculation. The pressure occurs twice, once for the parallelized isotropic pressure and once for the tensorial pressure calculation. For pair forces, the pressure is calculated using the virials, for many body interactions currently no pressure is calculated.</li>
</ul>
<p>Note that the force and energy functions cannot alter the particle states.</p>
<h2><a class="anchor" id="bondedIA_new_interface"></a>
Adding the interaction in the Python interface</h2>
<p>Please note that the following is Cython code (www.cython.org), rather than pure Python.</p>
<ul>
<li>In file <code>src/python/espressomd/interactions.pxd</code>:<ul>
<li>Import the parameter data structure from the C++ header file for the new interaction with an alias. For the FENE bond, this looks like: <div class="fragment"><div class="line">c<span class="keyword">def </span>extern <span class="keyword">from</span> <span class="stringliteral">&quot;bonded_interactions/bonded_interaction_data.hpp&quot;</span>:</div>
<div class="line">    <span class="comment"># Parameters for FENE bond</span></div>
<div class="line">    cdef cppclass CoreFeneBond <span class="stringliteral">&quot;FeneBond&quot;</span>:</div>
<div class="line">        CoreFeneBond()</div>
<div class="line">        CoreFeneBond(double k, double drmax, double r0)</div>
<div class="line">        double k</div>
<div class="line">        double drmax</div>
<div class="line">        double r0</div>
<div class="line">        double drmax2</div>
<div class="line">        double drmax2i</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>In file <code>src/python/espressomd/interactions.pyx</code>:<ul>
<li>Add the bonded interaction to <code>enum_bonded_interaction</code>. The order of the enum values must match the order of types in <a class="el" href="bonded__interaction__data_8hpp.html#ae9c6a4fa697aa0a90b4dceb7b79e1f5f">Bonded_IA_Parameters</a> exactly: <div class="fragment"><div class="line">cdef enum enum_bonded_interaction:</div>
<div class="line">    BONDED_IA_NONE = 0,</div>
<div class="line">    BONDED_IA_FENE,</div>
<div class="line">    [...]</div>
</div><!-- fragment --></li>
<li>Implement the Cython class for the bonded interaction, using the one for the FENE bond as template. Please use pep8 naming convention.</li>
<li>Create a new entry in the dictionary <code>bonded_interaction_classes</code> to register the new class you have written: <div class="fragment"><div class="line">bonded_interaction_classes = {</div>
<div class="line">    int(BONDED_IA_FENE): FeneBond,</div>
<div class="line">    int(BONDED_IA_HARMONIC): HarmonicBond,</div>
<div class="line">    [...]</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>In file <code>testsuite/python/interactions_bonded_interface.py</code>:<ul>
<li>Add a test case to verify that parameters set and gotten from the interaction are consistent.</li>
</ul>
</li>
<li>In file <code>testsuite/python/interactions_bonded.py</code> or <code>testsuite/python/interactions_bond_angle.py</code> or <code>testsuite/python/interactions_dihedral.py</code>:<ul>
<li>Add a test case to verify the forces and energies are correct.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="bondedIA_bond_angles"></a>
Bond angle potentials</h1>
<h2><a class="anchor" id="bondedIA_angle_force"></a>
General expressions for the forces</h2>
<p>This section uses the particle force expressions derived in <a class="el" href="citelist.html#CITEREF_swope92a">[47]</a>.</p>
<p>The gradient of the potential at particle \( i \) is given by the chain rule in equation 6:</p>
<p class="formulaDsp">
\begin{equation} \label{eq:Swope-eq-6} \nabla_i U(\theta_{ijk}) = \left( \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}} \right) \left( \frac{\mathrm{d}\theta_{ijk}}{\mathrm{d}\cos(\theta_{ijk})} \right) \left( \nabla_i \cos(\theta_{ijk}) \right) \end{equation}
</p>
<p>with</p>
<p class="formulaDsp">
\[ \left( \frac{\mathrm{d}\theta_{ijk}}{\mathrm{d}\cos(\theta_{ijk})} \right) = \left( \frac{-1}{\sin(\theta_{ijk})} \right) \]
</p>
<p>and \( \theta_{ijk} \) the angle formed by the three particles, \( U(\theta_{ijk}) \) the bond angle potential, \( \vec{r_{ij}} \) the vector from particle \( j \) to particle \( i \) and \( \nabla_i \) the gradient in the direction \( \vec{r_{ij}} \).</p>
<p>The expression for \( \cos(\theta_{ijk}) \) is given by equation 4:</p>
<p class="formulaDsp">
\begin{equation} \label{eq:Swope-eq-4} \cos(\theta_{ijk}) = \frac{\vec{r_{ij}}\cdot\vec{r_{kj}}} {\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|} \end{equation}
</p>
<p>The expression for its gradient is given by equation 9:</p>
<p class="formulaDsp">
\begin{equation} \label{eq:Swope-eq-9} \nabla_i \cos(\theta_{ijk}) = \vec{e_x}\frac{\partial\cos(\theta_{ijk})}{\partial x_{ij}} + \vec{e_y}\frac{\partial\cos(\theta_{ijk})}{\partial y_{ij}} + \vec{e_z}\frac{\partial\cos(\theta_{ijk})}{\partial z_{ij}} \end{equation}
</p>
<p>with \( \left(\vec{e_x}, \vec{e_y}, \vec{e_z}\right) \) the unit vectors of the reference coordinate system and \( \vec{r_{ij}} = \left(x_{ij}, y_{ij}, z_{ij}\right) \).</p>
<p>Applying the quotient rule:</p>
<p class="formulaDsp">
\[ \frac{\partial\cos(\theta_{ijk})}{\partial x_{ij}} = \frac{\partial}{\partial x_{ij}} \left( \frac{\vec{r_{ij}}\cdot\vec{r_{kj}}} {\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|} \right) = \frac{\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\| \partial \left(\vec{r_{ij}}\cdot\vec{r_{kj}}\right) /\, \partial x_{ij} - \vec{r_{ij}}\cdot\vec{r_{kj}}\cdot \partial \left( \left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\| \right) /\, \partial x_{ij}} {\left\|\vec{r_{ij}}\right\|^2\left\|\vec{r_{kj}}\right\|^2} \]
</p>
<p>with</p>
<p class="formulaDsp">
\[ \frac{\partial \left(\vec{r_{ij}}\cdot\vec{r_{kj}}\right)} {\partial x_{ij}} = \frac{\partial \left(x_{ij} \cdot x_{kj} + y_{ij} \cdot y_{kj} + z_{ij} \cdot z_{kj}\right)} {\partial x_{ij}} = x_{kj} \]
</p>
<p>and</p>
<p class="formulaDsp">
\[ \frac{\partial \left(\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|\right)} {\partial x_{ij}} = \left\|\vec{r_{kj}}\right\| \frac{\partial}{\partial x_{ij}} \sqrt{x_{ij}^2 + y_{ij}^2 + z_{ij}^2} = \left\|\vec{r_{kj}}\right\| \frac{0.5 \cdot 2 \cdot x_{ij}} {\sqrt{x_{ij}^2 + y_{ij}^2 + z_{ij}^2}} = x_{ij} \frac{\left\|\vec{r_{kj}}\right\|} {\left\|\vec{r_{ij}}\right\|} \]
</p>
<p>leading to equation 12:</p>
<p class="formulaDsp">
\begin{align*} \label{eq:Swope-eq-12} \frac{\partial\cos(\theta_{ijk})}{\partial x_{ij}} &amp;= \frac{\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|x_{kj} - \vec{r_{ij}}\cdot\vec{r_{kj}}\cdot x_{ij} \left\|\vec{r_{kj}}\right\|\left\|\vec{r_{ij}}\right\|^{-1}} {\left\|\vec{r_{ij}}\right\|^2\left\|\vec{r_{kj}}\right\|^2} \\ &amp;= \frac{x_{kj}} {\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|} - \frac{\vec{r_{ij}}\cdot\vec{r_{kj}}\cdot x_{ij}} {\left\|\vec{r_{ij}}\right\|^3\left\|\vec{r_{kj}}\right\|} \\ &amp;= \frac{1}{\left\|\vec{r_{ij}}\right\|} \left( \frac{x_{kj}}{\left\|\vec{r_{kj}}\right\|} - \frac{x_{ij}}{\left\|\vec{r_{ij}}\right\|} \cos(\theta_{ijk}) \right) \end{align*}
</p>
<p>Applying these steps to equations 9-11 leads to the force equations for all three particles:</p>
<p class="formulaDsp">
\begin{align*} \vec{F_i} &amp;= - K(\theta_{ijk}) \frac{1}{\left\|\vec{r_{ij}}\right\|} \left( \frac{\vec{r_{kj}}}{\left\|\vec{r_{kj}}\right\|} - \frac{\vec{r_{ij}}}{\left\|\vec{r_{ij}}\right\|} \cos(\theta_{ijk}) \right) \\ \vec{F_k} &amp;= - K(\theta_{ijk}) \frac{1}{\left\lVert\vec{r_{kj}}\right\rVert} \left( \frac{\vec{r_{ij}}}{\left\|\vec{r_{ij}}\right\|} - \frac{\vec{r_{kj}}}{\left\|\vec{r_{kj}}\right\|} \cos(\theta_{ijk}) \right) \\ \vec{F_j} &amp;= -\left(\vec{F_i} + \vec{F_k}\right) \end{align*}
</p>
<p>with \( K(\theta_{ijk}) \) the angle force term, which depends on the expression used for the angle potential. Forces \( \vec{F_i} \) and \( \vec{F_k} \) are perpendicular to the displacement vectors \( \vec{r_{ij}} \) resp. \( \vec{r_{kj}} \) and their magnitude are proportional to the potential gradient normalized by the displacement vectors:</p>
<p class="formulaDsp">
\begin{align*} \left\|\vec{F_i}\right\| &amp;= \left( \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}} \right) \frac{1}{\left\|\vec{r_{ij}}\right\|} \\ \left\|\vec{F_k}\right\| &amp;= \left( \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}} \right) \frac{1}{\left\|\vec{r_{kj}}\right\|} \end{align*}
</p>
<h2><a class="anchor" id="bondedIA_angle_potentials"></a>
Available potentials</h2>
<h3><a class="anchor" id="bondedIA_angle_harmonic"></a>
Harmonic angle potential</h3>
<p>The harmonic angle potential takes the form:</p>
<p class="formulaDsp">
\begin{equation} \label{eq:harmonic-angle-pot} U(\theta_{ijk}) = \frac{1}{2}k_{ijk}\left[\theta_{ijk} - \theta_{ijk}^0\right]^2 \end{equation}
</p>
<p>with \( \theta_{ijk} \) the angle formed by the three particles, \( \theta_{ijk}^0 \) the equilibrium angle and \( k_{ijk} \) the bond angle force constant.</p>
<p>The derivative with respect to the angle is:</p>
<p class="formulaDsp">
\[ \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}} = k_{ijk}\left[\theta_{ijk} - \theta_{ijk}^0\right] \]
</p>
<p>resulting in the following angle force term:</p>
<p class="formulaDsp">
\begin{equation} \label{eq:harmonic-angle-pot-angle-term} K(\theta_{ijk}) = -k_{ijk}\frac{\theta_{ijk} - \theta_{ijk}^0} {\sin(\theta_{ijk})} \end{equation}
</p>
<p>which can lead to numerical instability at \( \theta_{ijk} = 0 \) and \( \theta_{ijk} = \pi \).</p>
<h3><a class="anchor" id="bondedIA_angle_cossquare"></a>
Harmonic cosine potential</h3>
<p>The harmonic cosine potential takes the form:</p>
<p class="formulaDsp">
\begin{equation} \label{eq:harmonic-cosine-pot} U(\theta_{ijk}) = \frac{1}{2} k_{ijk}\left[\cos(\theta_{ijk}) - \cos(\theta_{ijk}^0)\right]^2 \end{equation}
</p>
<p>with \( \theta_{ijk} \) the angle formed by the three particles, \( \theta_{ijk}^0 \) the equilibrium angle and \( k_{ijk} \) the bond angle force constant.</p>
<p>The derivative with respect to the angle is:</p>
<p class="formulaDsp">
\[ \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}} = -k_{ijk}\sin(\theta_{ijk}) \left[\cos(\theta_{ijk}) - \cos(\theta_{ijk}^0)\right] \]
</p>
<p>resulting in the following angle force term:</p>
<p class="formulaDsp">
\begin{equation} \label{eq:harmonic-cosine-pot-angle-term} K(\theta_{ijk}) = k_{ijk}\left[\cos(\theta_{ijk}) - \cos(\theta_{ijk}^0)\right] \end{equation}
</p>
<p>which does not suffer from numerical instability.</p>
<h3><a class="anchor" id="bondedIA_angle_cosine"></a>
Cosine potential</h3>
<p>The cosine potential takes the form:</p>
<p class="formulaDsp">
\begin{equation} \label{eq:cosine-pot} U(\theta_{ijk}) = k_{ijk}\left[1 - \cos(\theta_{ijk} - \theta_{ijk}^0)\right] \end{equation}
</p>
<p>with \( \theta_{ijk} \) the angle formed by the three particles, \( \theta_{ijk}^0 \) the equilibrium angle and \( k_{ijk} \) the bond angle force constant.</p>
<p>The derivative with respect to the angle is:</p>
<p class="formulaDsp">
\[ \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}} = k_{ijk}\sin(\theta_{ijk} - \theta_{ijk}^0) \]
</p>
<p>resulting in the following angle force term:</p>
<p class="formulaDsp">
\begin{equation} \label{eq:cosine-pot-angle-term} K(\theta_{ijk}) = -k_{ijk}\frac{\sin(\theta_{ijk} - \theta_{ijk}^0)} {\sin(\theta_{ijk})} \end{equation}
</p>
<p>which can lead to numerical instability at \( \theta_{ijk} = 0 \) and \( \theta_{ijk} = \pi \).</p>
<h3><a class="anchor" id="bondedIA_angle_tab"></a>
Tabulated potential</h3>
<p>The tabulated potential and its derivative with respect to the angle are provided by the user. The angle force term takes the form:</p>
<p class="formulaDsp">
\begin{equation} \label{eq:tabulated-pot-angle-term} K(\theta_{ijk}) = \frac{-1}{\sin(\theta_{ijk})} \left( \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}} \right) \end{equation}
</p>
<p>which can lead to numerical instability at \( \theta_{ijk} = 0 \) and \( \theta_{ijk} = \pi \). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="aclassUtils_1_1Vector_html"><div class="ttname"><a href="classUtils_1_1Vector.html">Utils::Vector</a></div><div class="ttdef"><b>Definition:</b> <a href="Vector_8hpp_source.html#l00041">Vector.hpp:41</a></div></div>
<div class="ttc" id="astructFeneBond_html"><div class="ttname"><a href="structFeneBond.html">FeneBond</a></div><div class="ttdoc">Parameters for FENE bond Potential.</div><div class="ttdef"><b>Definition:</b> <a href="fene_8hpp_source.html#l00038">fene.hpp:38</a></div></div>
<div class="ttc" id="anamespaceCoulomb_html_a756bd1c367d1c6bda424090134c7013f"><div class="ttname"><a href="namespaceCoulomb.html#a756bd1c367d1c6bda424090134c7013f">Coulomb::cutoff</a></div><div class="ttdeci">double cutoff(const Utils::Vector3d &amp;box_l)</div><div class="ttdef"><b>Definition:</b> <a href="coulomb_8cpp_source.html#l00113">coulomb.cpp:113</a></div></div>
<div class="ttc" id="anamespaceboost_1_1serialization_html_a955fbdf06d317317d76921465e894ef4"><div class="ttname"><a href="namespaceboost_1_1serialization.html#a955fbdf06d317317d76921465e894ef4">boost::serialization::serialize</a></div><div class="ttdeci">void serialize(Archive &amp;ar, PairInfo &amp;p, const unsigned int)</div><div class="ttdef"><b>Definition:</b> <a href="cells_8cpp_source.html#l00090">cells.cpp:90</a></div></div>
<div class="ttc" id="aDipolarBarnesHut__cuda_8cu_html_a49f2a9bfcf5f73fc8e2d58bf78819909"><div class="ttname"><a href="DipolarBarnesHut__cuda_8cu.html#a49f2a9bfcf5f73fc8e2d58bf78819909">force</a></div><div class="ttdeci">__global__ float * force</div><div class="ttdef"><b>Definition:</b> <a href="DipolarBarnesHut__cuda_8cu_source.html#l00689">DipolarBarnesHut_cuda.cu:689</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Aug 31 2021 01:35:09 for ESPResSo by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
